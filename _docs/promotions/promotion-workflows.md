



## Promotion Workflows


Promotion Workflows validate the readiness of target environments for promotion. They are configured as part of Promotion Policies, which are activated during Promotion Flows.  

In structure and behavior, a Promotion Workflow is essentially an Argo Workflow. To classify and utilize an Argo Workflow or a Workflow Template as a Promotion Workflow, it must include the annotation attribute `metadata.annotations: codefresh.io/workflow-origin: promotion` in its manifest. 
See Features and Create Promotion Workflows

After creating Promotion Workflows, there are two main aspects to working with them:
1. Managing Promotion Workflows  
  Managing Promotion Workflows involves controlling the configuration of the manifest, creating new Promotion Workflows by copying existing ones, and removing workflows that are no longer needed or relevant.  
  See Managing Promotion Workflows.

1. Managing Workflow execution instances  
  Workflow execution instances represent specific occurrences when a Promotion Workflow is triggered either as part of a Promotion Policy, or run for validation. These instances provide detailed insights into the performance and execution of the specific instance of the Workflow.
  See Managaing Workflow instances. 




## Key features

##### Annotation attribute
An Argo Workflow or a Workflow Template is classified as a Promotion Workflow only when the following annotation is present in the workflow manifest:  
`metadata.annotations: codefresh.io/workflow-origin: promotion`

This annotation in the Promotion Workflow's manifest ensures that:
* The Promotion Workflow appears in the Promotion Workflows list and can be managed there
* You can assign the Promotion Workflow to Promotion Policies
* Select it when creating Promotion Flows
See Create Promotion Workflows.

##### Pre- and Post-Action Workflows
A Promotion Workflow is run as part of the Promotion Policy, and can be executed before or after the Promotion Action as a Pre-Action or a  Post-Action Workflow. The Promotion Action implements the changes to the environment.
See ???

##### Pre-commit dry run validation 
Inline validations are supplemented by dry-run validations. Instead of committing the manifest and then detecting errors or failures when the Workflow is activated during promotions, the Run option allows you to test and validate different settings validate at any time.
See ???

##### Arguments for Post-Action Workflows
Codefresh passes passes parameters generated by the commit action to a Post-Action Workflow. These arguments allow you to customize Post-Action Workflow execution based on the specific details of the commit. 


## Create Promotion Workflows

Create a Promotion Workflow from scratch, use the base Promotion Workflow Template, or use one of the predefined Promotion Workflows in Codefresh.

However you create your Promotion Workflow, make sure you include the annotation to classify and use it as a Promotion Workflow in the manifest.


1. In the Codefresh UI, from Promotions in the sidebar, select [Promotion Workflows](https://g.codefresh.io/2.0/?????){:target="\_blank"}.
1. Click **Add Promotion Workflow**.
1. Define the following:
  1. **Name**: The name of the Promotion Workflow.<br>The name must be unique in the cluster, and must match Kubernetes naming conventions. 
  1. **Description** : The intended use of the Promotion Workflow.<br>The description is added as an annotation to the YAML file. It is also displayed in the Promotion Workflows list in the UI. 
  1. **Resource Filename**: The name of the YAML resource file with the configuration settings for the Promotion Workflow, by default, identical to the Name of the Promotion Workflow. You can change as needed.  

SCREENSHOT

{:start="4"}
1. Click **Add**.
1. Select **Blank Skeleton File** and click **Next**.
  The YAML is displayed on the right populated with the settings you defined.

SCREENSHOT 
1. Note the instructions at the top of the YAML file.
1. If needed, change `metadata.annotations.version`.
  The version is displayed in the Promotion Workflows list in the UI.
  You should update it manually when there are changes.
1. To test the Promotion Workflow with the current settings before committing the changes, click **Run**.
?????
1. Make any updates needed.
1. Commit the changes.

When the YAML file is synced to the cluster, it is displayed in the Promotion Workflows list.




### Arguments for Post-Action Workflows

For Post-Action Workflows, Codefresh passes several parameters generated by the commit action to the Workflow. The same set of parameters are passed also for pull requests, after the pull request is merged.
At the simplest levels, you can display the details from the parameters in notifications. In more advanced scenarios, you can customize the Workflow execution based on specific parameters.

The table describes the parameters in Post-Action Workflows.

{: .table .table-bordered .table-hover}
| Parameters                     | Description            |  
| --------------           | --------------           |  
|`APP_NAME`| The specific name of the application, helping identify which application the commit and subsequent workflow execution pertain to. |
|`COMMIT_SHA`| The unique identifier (SHA) of the commit, generated by Git, including the precise set of changes addressed by the commit. Can be used to |
|`COMMIT_AUTHOR`| The name of the user who made the commit. Useful for tracking changes and for notifications.|
|`COMMIT-MESSAGE` | The context for the changes introduced by the commit. (NIMA: is this connected to the trigger in Promotion Flows?)
|`COMMIT-DATE`  | The date and time when the commit was made. Useful to correlate the commit with other events and understand the timeline of changes.|
|`ARGOCD_HOST` |The URL or IP address of the Argo CD server for retrieving additional details about the deployment environment or triggering further actions in the Post-Action Workflow.

<!--- The specific attribute from the Git payload to evaluate, and can be one of the following:{::nomarkdown}<ul><li><code class="highlighter-rouge">commitMessage</code>: Trigger the Promotion Flow based on the text description associated with the commit message. The commit message is matched against the values provided.</li><li><code class="highlighter-rouge">gitRevision</code>: Trigger the Promotion Flow based on the commit hash generated by Git as a unique identifier for the commit. The commit hash is matched against the values provided.</li></ul>{:/} | string   | Required    |  -->







## Promotion Workflow list

All Argo Workflows which include `metadata.annotations: codefresh.io/workflow-origin: promotion` are displayed in the Promotion Workflows list.

SCREENSHOT

The Description and Version information are retrieved from the manifest if these are specified there.
The Promotion Workflows list is also the centralized location from which you can manage both Workflows (see ) and Workflow instances (see ). 

## Managing Promotion Workflows
After you create a Promotion Workflow, you can:
* Optimize the manifest by updating steps or refining the logic to better suit evolving requirements
* Validate the current version of the manifest 
* Copy and delete Promotion Workflows
  


### Update Promotion Workflow manifests
Update and optimize the Promotion Workflow manifest including steps, actions, and required parameters to adapt to changing requirements.  
When triggered, the Promotion Workflow uses the current version of the manifest, ensuring that the Workflow execution instance always uses the latest configurations and optimizations.

Past executions are not affected as the manifests can be updated independently of individual workflow executions.

You can:
* Toggle between the Git State, Desired State, and Live State
* Render Diff views of all three states
* Update manifest


1. In the Codefresh UI, from Promotions in the sidebar, select [Promotion Workflows](https://g.codefresh.io/2.0/?????){:target="\_blank"}.
1. Do one of the following:
  * From the context menu of the Promotion Workflow select **Edit**.
  * Click the name of the Promotion Workflow.
1. In the Manifest tab, do any of the following:
  * Identify **Errors** or **Warnings** if any. 
  * To make changes, make sure **Git State** is selected and then click **Edit**.
  * To view the differences between the three states, click **Diff View**, and toggle between **Full** and **Compact** views.

SCREENSHOTS OF DIFF VIEW AND MANIFEST WITH ERRORS


### Validate Promotion Workflows  

When you either create a Promotion Workflow or modify the manifest of an existing workflow, you can validate the new Workflow or the changes made before committing them to Git.
The Run option is an ddition to the inline validations which Codefresh automatically performs, to verify settings and confirm that the workflow hat it does what it is expected to do.

1. In the Codefresh UI, from Promotions in the sidebar, select [Promotion Workflows](https://g.codefresh.io/2.0/?????){:target="\_blank"}.
1. Click the name of the Promotion Workflow to validate.
1. Click **Run** at the top-right.
   Codefresh displays the parameters passed in the Promotion Workflow. 

1. Modify as needed.
1. Click **Run** at the bottom of the form.
???


### Copy Promotion Workflows
Copy an existing Promotion Workflow to create a new Promotion Workflow with the same manifest configuration.

1. In the Codefresh UI, from Promotions in the sidebar, select [Promotion Workflows](https://g.codefresh.io/2.0/?????){:target="\_blank"}.
1. From the context menu of the Promotion Workflow select **Copy**.
1. Enter the **Name**, **Description**, and **Resource Filename** for the new Workflow.
1. Update the manifest if needed.
1. Commit the changes.





### Delete Promotion Workflows
Delete unused legacy Promotion Workflows. Deleting a Promotion Workflow removes it from the Promotion Workflow list, from the Promotion Policies it is configured in, and from the Promotion Flows. 

1. In the Codefresh UI, from Promotions in the sidebar, select [Promotion Workflows](https://g.codefresh.io/2.0/?????){:target="\_blank"}.
1. From the context menu of the Promotion Workflow select **Delete**.
1. Enter the name of the Promotion Workflow to confirm.
1. Optional. Add a commit message and description.
1. To confirm, click **Commit & Delete**.


## Managing Workflow instances
, including the specific manifests used for each instance to verify configuration and parameters, analyze ndividual steps of the workflow, and view detailed logs to troubleshoot  execution flow. 

SCREENSHOT


Manage PWs
- Update manifests
- Validate PWs
- View executions/runs/instances
- Analyze executions


### View/analyze Workflow instances

View instances of a Promotion Workflow. In addition to the status which is prominently displayed on the right for each execution instance, you can filter by products, environments and applications to get to the instances of interest to you. 

1. In the Codefresh UI, from the sidebar, select **Promotion Workflows**.
1. Click a Promotion Workflow, and then click the **Workflows** tab to see its instances.
1. If needed, filter by Status, Target Environment, Product, or Application.
1. To visualize steps and view detailed information, click **View Workflow Details**.

SCREENSHOT 

### Run a Workflow


### Workflow summary

The Workflow Summary presents modular information for the selected Workflow instance.  
The table highligts key information you can find in the Summary tab for a workflow.

{: .table .table-bordered .table-hover}
|  Workflow Summary    | Description                   | 
| --------------       | ------------------------------|  
| **Errors**               | Displayed when the Workflow instance has at least one failed step.   |  
| **Summary**              | Namespace, memory and CPU resource usage, and execution context of the workflow.<br>If triggered by a parent workflow, displays the link to that workflow.|  
| **Manifests**            | The version of the manifest used for the specific Workflow execution. This may not be the same version currently displayed in the Manifest tab. Useful to troubleshoot failed steps and errors in the execution instance. |  
| **Labels**            | Labels assigned to the workflow. Useful to filter, search, organize workflow executions. <br>Examples:<br>`codefresh.io/app-name: trioapp-qa`, `codefresh.io/app-namespace: gitops`.| 
| **Parameters**            | The inputs set/modified for the specific execution. <br>Examples:<br>`Threshold: 50`, `Nb: 100`.| 
| **Artifacts**            | The outputs if any generated by a workflow step, and can be logs, test-reports, binaries or any other type of file. Each artifact is associated with a specific step in the workflow. For example: `main-logs: smoketests-k9ss6`.| 

###  Workflow actions
Depending on the status of the workflow instance, you can do the following: 

* **Resubmit**: Rerun or re-execute the Workflow. Resubmitting a Workflow, creates a new instance of the Workflow.  You can resubmit both successful and failed workflows.
* **Delete**: Remove unused or legacy workflow instances. Deleting a workflow instance removes it from the list of executions. The Promotion Workflow is not changed.

### Workflow steps
For additional information on the step, click the step to open the pull-out panel.
* The header displays the name of the step, its status, the step-type, the date of the most recent update, and duration.  
* The tabs displayed differ according to the step type:  
  * The Summary, Manifest, Containers, Inputs, Outputs tabs are displayed for all alomst all step types. (NIMA: what about Artifacts??)
  * The Logs tab is displayed for Pod step types.
  * Event-step types display Manifest, Summary, and Payload.
    For Cron and Unknown event types, only the Event Sources are shown. 


### Workflow logs
View online logs for ongoing or completed Workflows. As with logs in any standard terminal, you can copy/cut/paste log info. The commands differ based on the OS.
  * For an ongoing Workflow, view live logs for steps as they are being executed.  
  * For a completed Workflow, view logs for the Workflow, or for any step in the workflow.  

NIMA: Ask about archived workflows.







* Analyze the workflow: Analyze each step in the workflow, including the Argo Events that triggered the pipeline
* View workflow logs: Real-time logs for ongoing workflows, and archived logs for completed workflows
* Manage the workflow: Retry, resubmit, or delete workflows

## View Workflow executions/submissions

See all all the instances of the Promotion Workflow submitted and run as part of different Promotion Policies in the Workflows tab.

In addition to the Status which is prominently displayed on the right of every workflow entry, you can filter workflow executions by products, environments, or applications.

Filters: 

Workflow run entry
* Merge request details
* SHA
* Commit author
* Repo and branh
* Workflow stats
* Date and duration of the workflow
* Status 
* View Workflow Details: 

## Analyze Workflow execution instance
Visualize the steps in the Workflow, detailed information on a step. 








## Managing Promotion Workflows

Manage existing Promotion Workflows by modifying, copying, deleting them.

: Modify Workflow manifest settings. You must be in Git State to edit Workflow manifest.   

1. In the Codefresh UI, from Promotions in the sidebar, select [Promotion Workflows](https://g.codefresh.io/2.0/?????){:target="\_blank"}.
1. In the **Promotion Workflows** list, select the Promotion Workflow to copy/edit/delete.
1. Open the context menu, and select the required option. 

{: .table .table-bordered .table-hover}
| Item                     | Description            |  
| --------------         | --------------           |  
|Edit  | Update manifest. Clicking Edit opens You must be in Git State to enable Edit. After updating the manifest, before committing changes you can Run the workflow. |
|Copy  | Copy existing workflow with a new Name, Description, and resource filename  |
|Delete  | Delete existing workflow. Deleting the workflow removes it from all the Promotion Policies it is assigned to or selected for. |

### Copy Promotion Workflow

### Edit Promotion Workflow

### Delete Promotion Workflow


## Promotion Workflow steps in Promotion Flows
User will be able to view the Argo Workflow details view (in drawer mode) when promotion is in progress and after it has been completed.

## Promotion Workflows in Promotion Policies